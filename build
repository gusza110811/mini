#!/usr/bin/env bash
set -e

IMAGE="distro.img"
SIZE="600M"        # adjust as needed
ESP_SIZE="100M"

BOOT_SRC="./boot"
ROOT_SRC="./root"

# clean up stale loops
sudo losetup -D

echo "[1] Creating empty disk image..."
dd if=/dev/zero of="$IMAGE" bs=1 count=0 seek="$SIZE"

echo "[2] Creating GPT partition table..."
parted "$IMAGE" --script mklabel gpt
parted "$IMAGE" --script mkpart ESP fat32 1MiB "$ESP_SIZE"
parted "$IMAGE" --script set 1 esp on
parted "$IMAGE" --script mkpart root ext4 "$ESP_SIZE" 100%

echo "[3] Attaching loop device..."
LOOP=$(sudo losetup --find --partscan --show "$IMAGE")
echo "Loop device: $LOOP"

ESP="${LOOP}p1"
ROOT="${LOOP}p2"

echo "[4] Formatting partitions..."
sudo mkfs.fat -F32 "$ESP"
sudo mkfs.ext4 "$ROOT" -L "LINUX"

echo "[5] Mounting partitions..."
mkdir -p mnt/esp mnt/root
sudo mount "$ESP" mnt/esp
sudo mount "$ROOT" mnt/root

echo "[6] Copying root filesystem..."
sudo cp -a "${ROOT_SRC}/." mnt/root/

echo "[7] Setting root FS label..."
sudo e2label "$ROOT" LINUX

echo "[8] Installing systemd-boot into ESP..."
sudo bootctl --esp-path=$(realpath mnt/esp) install

echo "[9] Copying kernel + loader config..."
sudo cp "${BOOT_SRC}/vmlinuz" mnt/esp/
sudo cp "${BOOT_SRC}/initrd" mnt/esp/

# Ensure loader structure exists
sudo mkdir -p mnt/esp/loader/entries
sudo cp "${BOOT_SRC}/loader.conf" mnt/esp/loader/
sudo cp "${BOOT_SRC}/linux.conf" mnt/esp/loader/entries/

echo "[10] Sync + cleanup..."
sync
sudo umount mnt/esp
sudo umount mnt/root
sudo losetup -d "$LOOP"

echo "Done! Bootable UEFI image created: $IMAGE"
